# Sports Prediction Architectures: Low-Risk Modeling

This repository contains research and implementation details for four distinct architectural approaches to sports betting prediction. The primary objective of this project is **Risk Minimization**, specifically targeting a **90% Confidence Interval (10% Risk)** for Basketball *Alternative Over/Under* markets.

## Table of Contents

1. [Architectures Overview](#architectures-overview)
    - [1. GNN + Transformer](#1-gnn--transformer-deep-learning)
    - [2. Gradient Boosting (XGBoost)](#2-gradient-boosting-xgboost)
    - [3. PID Controller](#3-pid-controller-reactive-risk)
    - [4. Conformal Prediction](#4-conformal-prediction-statistical-risk)
2. [Project Structure](#project-structure)
3. [Data Acquisition (Scraper)](#data-acquisition-scraper)
4. [Live API Endpoints](#live-api-endpoints)
5. [Comparative Analysis](#comparative-analysis)
6. [The Recommended Stack](#the-recommended-stack)
7. [Implementation Logic](#implementation-logic)

---

## Project Structure

```text
SportyBet/
├── README.md

├── data/
│   ├── raw/
│   │   ├── matches/
│   │   │   └── sportybet_YYYY_MM_DD.json
│   │   └── stats/
│   │       ├── cba_raw.csv
│   │       └── lnb_raw.csv
│   │
│   ├── processed/
│   │   ├── cba_features.parquet
│   │   ├── lnb_features.parquet
│   │   └── metadata.json
│   │
│   └── splits/
│       ├── cba_train.csv
│       ├── cba_calibration.csv
│       └── cba_test.csv

├── models/
│   ├── xgboost/
│   │   ├── train.py
│   │   ├── predict.py
│   │   ├── features.py
│   │   └── model.bin
│   │
│   └── conformal/
│       ├── calibrate.py
│       ├── buffers.json
│       └── diagnostics.py

├── strategy/
│   ├── threshold.py
│   ├── selector.py
│   └── bet_rules.md

├── simulation/
│   ├── bankroll.py
│   ├── backtest.py
│   └── reports/

├── services/
│   ├── matchfetcher/        ← your EXISTING puppeteer app
│   │   ├── server.js
│   │   ├── puppeteer.config.cjs
│   │   └── package.json
│   │
│   └── predictor_api/
│       ├── app.py
│       └── routes.py

└── notebooks/
    ├── residuals.ipynb
    └── feature_sanity.ipynb
```

---

## Data Acquisition (Scraper)

The system includes a Puppeteer-based scraper to fetch live odds from SportyBet.

**Features:**
- Headless browsing with realistic User-Agent.
- Dynamic selector waiting for async data loading.
- JSON data extraction for Match ID, Teams, Time, and Odds (Winner, Over/Under).

**Local Setup:**
```bash
npm install
npm start
```

## Live API Endpoints

The project is deployed on Render and provides a public API for match data.

- **Base URL:** `https://sportybet-vj0n.onrender.com`
- **GET `/api/matches`**: Returns a list of all scraped matches.
    - [View Live Matches](https://sportybet-vj0n.onrender.com/api/matches)
- **POST `/api/scrape`**: Manually triggers a fresh scrape (useful for cron jobs).

---

## Architectures Overview

### 1. GNN + Transformer (Deep Learning)
**Role:** Relationship & Sequence Modeling  
**Status:** *Cutting Edge / Experimental*

This hybrid architecture treats the league as a graph and the season as a sequence.
*   **Graph Neural Network (GNN):** Treats Teams as **Nodes** and Matches as **Edges**. It updates "Team Strength Embeddings" based on who played whom. (e.g., A win against a strong opponent is weighted heavier than a win against a weak one).
*   **Transformer:** Takes the sequence of embeddings generated by the GNN to model momentum, fatigue, and form over time.

**Verdict:** Extremely powerful for feature extraction but often over-complex for simple tabular sports statistics. prone to "over-smoothing" in fully connected leagues.

### 2. Gradient Boosting (XGBoost)
**Role:** Regression & Classification  
**Status:** *Industry Standard*

A decision-tree ensemble method that builds models sequentially to correct the errors of previous models.
*   **Strengths:** Best-in-class performance on tabular data (Points, Rebounds, Pace, Efficiency).
*   **Feature Importance:** Automatically determines which factors (e.g., "Away Team Defense") matter most.

**Verdict:** Generally creates the most accurate point predictions ($\mu$) for sports datasets under 100,000 samples.

### 3. PID Controller (Reactive Risk)
**Role:** Dynamic Error Correction  
**Status:** *Not Recommended for Prediction*

A Control Theory mechanism used to adjust the "Safety Margin" based on recent model performance.
*   **Proportional (P):** Reacts to the immediate error of the last match.
*   **Integral (I):** Reacts to accumulated bias over time.
*   **Derivative (D):** Reacts to sudden changes in league scoring trends.

**Verdict:** **Rejected.** PID is *reactive*. If a specific match is an anomaly (players shot poorly), PID overcorrects the next prediction, potentially ruining a valid bet.

### 4. Conformal Prediction (Statistical Risk)
**Role:** Confidence Interval Generation  
**Status:** *Mathematically Correct*

A rigorous statistical framework that transforms point predictions into prediction *sets* or *intervals* with a guaranteed coverage probability.
*   **Calibration:** Uses a hold-out dataset to calculate the distribution of errors.
*   **Safety Buffer:** Calculates the exact margin ($N$) required to ensure that 90% of historical actual outcomes fall above `Predicted - N`.

**Verdict:** **Accepted.** This is the scientifically correct way to guarantee a 10% risk profile.

---

## Comparative Analysis

| Feature | GNN + Transformer | XGBoost | PID Controller | Conformal Prediction |
| :--- | :--- | :--- | :--- | :--- |
| **Primary Use** | Complex Relations | Tabular Accuracy | System Stability | Risk Management |
| **Data Type** | Graphs/Sequences | Structured Stats | Time-series Error | Residual Errors |
| **Accuracy** | High (Hard to tune) | **Highest** | Low (Reactive) | N/A (Calibrator) |
| **Risk Control**| Low (Black box) | Medium | Medium | **Highest** |
| **Complexity** | High | Low | Low | Low |

---

## The Recommended Stack

For maximum accuracy and minimum risk, this project utilizes a **Hybrid Pipeline** rather than a single model.

1.  **Feature Engineering (GNN):** Use a shallow GAT (Graph Attention Network) to generate "Opponent Strength Embeddings."
2.  **Prediction Engine (XGBoost):** Feed the GNN embeddings + raw stats (Four Factors) into XGBoost to predict the **Total Points**.
3.  **Risk Engine (Conformal Prediction):** Use Conformal Prediction on the XGBoost residuals to calculate the dynamic **Safety Buffer**.

### The "Floor" Strategy
The system does not bet on the predicted total. It bets on the **Mathematical Floor**.

> **Formula:** `Target Line = XGBoost_Prediction - Conformal_Safety_Buffer`

---

## Implementation Logic

### Python Pseudo-Code for the Hybrid Pipeline

```python
import numpy as np
import xgboost as xgb

# 1. Prediction Phase (XGBoost)
# ---------------------------------------------
# Train model on historical data (Pace, Efficiency, GNN Embeddings)
model = xgb.XGBRegressor()
model.fit(X_train, y_train)

# 2. Calibration Phase (Conformal Prediction)
# ---------------------------------------------
# Predict on a calibration set the model hasn't seen
preds_cal = model.predict(X_cal)
actuals_cal = y_cal

# Calculate Signed Errors (Prediction - Actual)
# We focus on cases where Actual < Prediction (The risk for OVER betting)
errors = preds_cal - actuals_cal

# Calculate the 90th Percentile of Error
# This is the buffer needed to cover 90% of historical misses
safety_buffer = np.percentile(errors, 90)
print(f"Required Safety Buffer for 90% Confidence: {safety_buffer} points")

# 3. Execution Phase (Live Betting)
# ---------------------------------------------
# Predict tonight's match
predicted_total = model.predict(todays_match_features)

# Apply the Floor Strategy
safe_bet_line = predicted_total - safety_buffer

print(f"Model predicts: {predicted_total}")
print(f"To maintain 10% risk, bet on: Alternative OVER {safe_bet_line}")